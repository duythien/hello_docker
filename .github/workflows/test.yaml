name: Rust

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  RUSTFLAGS: "-Dwarnings"
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    runs-on:  ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Build
      run: cargo build
    - name: Upload digest
      uses: actions/upload-artifact@v3
      with:
        name: node-template
        path: /home/runner/work/hello_docker/hello_docker
        if-no-files-found: error
        retention-days: 1
    
  run-test:
    needs: build
    runs-on:  ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Download
      id: download
      uses: actions/download-artifact@v3
      with:
        name: node-template
        path: ~/download/node-template
    - name: 'Echo download path'
      run: echo ${{steps.download.outputs.download-path}}
    - name: Cache rust
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
    - name: Run test
      run: cargo test  -- --test-threads=1 --verbose
  run-expensive-test:
    runs-on:  ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Run expensive test
      run: cargo test -- --ignored
